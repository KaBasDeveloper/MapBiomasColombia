/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var newSamples_30 = 
    /* color: #00ffff */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-74.83495877118867, 7.9393761391720945],
               [-74.83495877118867, 7.938016009213324],
               [-74.83289883466523, 7.938016009213324],
               [-74.83289883466523, 7.9393761391720945]]],
             [[[-74.83204052778046, 7.947283252938099],
               [-74.83204052778046, 7.945073082022788],
               [-74.82980892988007, 7.945073082022788],
               [-74.82980892988007, 7.947283252938099]]],
             [[[-74.8861138615207, 7.962754115908128],
               [-74.8861138615207, 7.960884042617369],
               [-74.88439724775117, 7.960884042617369],
               [-74.88439724775117, 7.962754115908128]]]], null, false),
        {
          "system:index": "0",
          "start": 1985,
          "finish": 2022
        }),
    newSamples_27 = 
    /* color: #bf04c2 */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Feature(
        ee.Geometry.MultiPolygon(
            [[[[-74.85813305707734, 7.930025154807888],
               [-74.85813305707734, 7.9293450749221215],
               [-74.85693142743867, 7.9293450749221215],
               [-74.85693142743867, 7.930025154807888]]],
             [[[-74.8231141361789, 7.975844389777769],
               [-74.8231141361789, 7.974484380817972],
               [-74.82088253827851, 7.974484380817972],
               [-74.82088253827851, 7.975844389777769]]],
             [[[-74.85126660199921, 7.966154227289164],
               [-74.85126660199921, 7.9649641915170095],
               [-74.84920666547578, 7.9649641915170095],
               [-74.84920666547578, 7.966154227289164]]],
             [[[-74.88731549115937, 7.991654161826075],
               [-74.88731549115937, 7.9889342446291405],
               [-74.88456890912812, 7.9889342446291405],
               [-74.88456890912812, 7.991654161826075]]],
             [[[-74.87701580854218, 7.9241608764666775],
               [-74.87701580854218, 7.921780558029419],
               [-74.87495587201875, 7.921780558029419],
               [-74.87495587201875, 7.9241608764666775]]],
             [[[-74.90739987226289, 7.945413109092015],
               [-74.90739987226289, 7.94048268902875],
               [-74.90379498334687, 7.94048268902875],
               [-74.90379498334687, 7.945413109092015]]],
             [[[-74.90705654950898, 7.958163920775773],
               [-74.90705654950898, 7.956803853084668],
               [-74.90465329023164, 7.956803853084668],
               [-74.90465329023164, 7.958163920775773]]]], null, false),
        {
          "system:index": "0",
          "start": 1985,
          "finish": 2022
        }),
    geometry = 
    /* color: #d63000 */
    /* shown: false */
    /* locked: true */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-59.71660781802973, 6.795003832653996],
                  [-59.69738174381098, 6.78750372786799],
                  [-59.649316558264104, 6.833184367925614],
                  [-59.61498428287348, 6.835229667860426],
                  [-59.60949111881098, 6.816139861806477],
                  [-59.57927871646723, 6.79159470860905],
                  [-59.55730606021723, 6.7847763880579155],
                  [-59.47971511783442, 6.783412712360362],
                  [-59.47971511783442, 7.001551196730549],
                  [-59.72484756412348, 7.002914244920299]]]),
            {
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-60.207765822523385, 7.61723790256024],
                  [-60.21059559769846, 7.615422181447236],
                  [-60.214541158910855, 7.615733283892761],
                  [-60.21848405254577, 7.6166957414374306],
                  [-60.22448153760913, 7.616238493431261],
                  [-60.22875164426407, 7.613962723456452],
                  [-60.2333434895978, 7.6100916527747415],
                  [-60.24944229224175, 7.604870502719436],
                  [-60.26622740870174, 7.601350255012177],
                  [-60.29224413065298, 7.599753297193487],
                  [-60.30126585008043, 7.600706250827563],
                  [-60.31124605200681, 7.6030712710662565],
                  [-60.314016527281915, 7.606457116028745],
                  [-60.33412499639355, 7.607120134913369],
                  [-60.34417915819229, 7.607281036078009],
                  [-60.34834788373408, 7.603107541894252],
                  [-60.35867197584923, 7.6062954885893905],
                  [-60.363502809424084, 7.599274139266864],
                  [-60.36896444055285, 7.5935244801653266],
                  [-60.38506892467926, 7.591177683584081],
                  [-60.40079820735791, 7.591928589439445],
                  [-60.413030353582606, 7.589346034599252],
                  [-60.425478439682486, 7.5933686172476715],
                  [-60.43870156973448, 7.5942661143578345],
                  [-60.46995327246038, 7.586869423933801],
                  [-60.48169428896606, 7.591614152393964],
                  [-60.52399072175228, 7.579681607745881],
                  [-60.54060522106326, 7.579637734347582],
                  [-60.556325904100284, 7.593161341385805],
                  [-60.5613040733978, 7.419906937661269],
                  [-60.55718415666435, 7.293922706395376],
                  [-60.23033940486007, 7.29324164316145],
                  [-59.5828297387406, 7.294603689915269],
                  [-59.5732165551667, 7.53496362650422],
                  [-59.64668793330935, 7.6329761354603916],
                  [-59.757238360448056, 7.7207599568883785],
                  [-59.819723387501305, 7.77927238459924],
                  [-59.832769899799274, 7.788117093072542],
                  [-60.044771681707324, 7.700683297335142],
                  [-60.05703279676888, 7.64234964161641],
                  [-60.068262076203766, 7.633013600359671],
                  [-60.08694240056661, 7.628972984446891],
                  [-60.09889558333078, 7.619870916117446],
                  [-60.122864489096955, 7.635437923404632],
                  [-60.12966705487532, 7.635691579994409],
                  [-60.14003134084686, 7.635390822137761],
                  [-60.140096098909176, 7.6483607694290745],
                  [-60.14915220495036, 7.651161899773556],
                  [-60.1639804935755, 7.645289100311444],
                  [-60.173658486609476, 7.635332695437032],
                  [-60.18889394529001, 7.6273289592944415]]]),
            {
              "system:index": "1"
            })]),
    newAreas = 
    /* color: #d63000 */
    /* shown: false */
    ee.Feature(
        ee.Geometry.Polygon(
            [[[-74.84943419547152, 8.187026624960772],
              [-74.84737425894808, 8.187196536814687],
              [-74.84376937003206, 8.188216006415706],
              [-74.84479933829378, 8.193653133531178],
              [-74.84497099967074, 8.199769812731935],
              [-74.84754592032503, 8.202488306622318],
              [-74.85527068228792, 8.202828117051444],
              [-74.86042052359652, 8.200959156096319],
              [-74.86299544425081, 8.196711484888992],
              [-74.86299544425081, 8.19212394903684],
              [-74.86145049185824, 8.188216006415706],
              [-74.85853224845003, 8.187366448596098]]]),
        {
          "year": 2020,
          "system:index": "0"
        }),
    exclusion_1 = /* color: #d63000 */ee.Feature(
        ee.Geometry.Polygon(
            [[[-76.72404043695734, 9.774107475920413],
              [-76.75150625726984, 9.36243583258979],
              [-76.54825918695734, 9.167261789650698],
              [-76.47135489008234, 9.248597480293409],
              [-76.41093008539484, 9.416631495876807],
              [-76.41093008539484, 9.530414663288816]]]),
        {
          "start": 2015,
          "finish": 2020,
          "system:index": "0"
        }),
    exclusion_1985_2008 = /* color: #d63000 */ee.Feature(
        ee.Geometry.MultiPoint(),
        {
          "start": 1985,
          "finish": 2008,
          "system:index": "0"
        }),
    inclusion_2020_2020 = /* color: #98ff00 */ee.Feature(
        ee.Geometry.MultiPoint(),
        {
          "start": 2020,
          "finish": 2020,
          "system:index": "0"
        }),
    exclusion_2020_2020 = /* color: #0b4a8b */ee.Feature(
        ee.Geometry.MultiPoint(),
        {
          "start": 2020,
          "finish": 2020,
          "system:index": "0"
        });
/***** End of imports. If edited, may not auto-convert in the playground. *****/
//Parametros

var param = {
  country: 'COLOMBIA',
  regions: [30424],
  roi: 'Mascara_Mineria_V3',
  trees: 60,
  years: [
    1985,1986,1987,1988,1989,1990,1991,1992,
    1993,
    //1994,1995,
    1996,1997,1998,1999,2000,
    2001,2002,2003,2004,2005,2006,2007,2008,
    2009,2010,2011,2012,2013,2014,2015,2016,
    2017,2018,2019,2020,2021,2022
  ],
  variables: [
    "ndvi_median", "ndfi_median", "evi2_median", "soil_median", "savi_median",
    "npv_median", "soil_amp", "nuaci_median", "ndfib_median", "gvs_median",
    "gcvi_median", "pri_median", "ndwi_gao_median", "ndwi_mcfeeters_median"
  ],
  yearsPreview: [2021],
  driveFolder: 'RF-PRELIMINAR-CLASSIFICATION',
  samplesVersion: 3,
  outputVersion: 1,
  newAreas: [ newAreas ],
  additionalSamples: { 
    polygons: [newSamples_30,newSamples_27,inclusion_2020_2020],
    classes:  [30,27,30],
    points:   [4000,4000,4000],
  },
  exclusion: [
    exclusion_1,exclusion_1985_2008,exclusion_2020_2020
  ]
};


/*
// Add NICFI Data
var nicfi = ee.ImageCollection('projects/planet-nicfi/assets/basemaps/americas');
// Filter basemaps by date and get the first image from filtered results
var basemap4= nicfi.filter(ee.Filter.date('2015-12')).first();
var basemap5= nicfi.filter(ee.Filter.date('2016-06')).first();
var basemap6= nicfi.filter(ee.Filter.date('2016-12')).first();
var basemap7= nicfi.filter(ee.Filter.date('2017-06')).first();
var basemap8= nicfi.filter(ee.Filter.date('2017-12')).first();
var basemap9= nicfi.filter(ee.Filter.date('2018-06')).first();
var basemap10= nicfi.filter(ee.Filter.date('2018-12')).first();
var basemap11= nicfi.filter(ee.Filter.date('2019-06')).first();
var basemap12= nicfi.filter(ee.Filter.date('2019-12')).first();
var basemap13= nicfi.filter(ee.Filter.date('2020-06')).first();
var basemap14= nicfi.filter(ee.Filter.date('2020-12')).first();
var basemap15= nicfi.filter(ee.Filter.date('2021-06')).first();
// Ajustes de visualiación para mosaicos NICFI
var vis = {"bands":["R","G","B"],"min":64,"max":1050,"gamma":0.74};
Map.addLayer(basemap4, vis, '2015-12', false);
Map.addLayer(basemap5, vis, '2016-06', false);
Map.addLayer(basemap6, vis, '2016-12', false);
Map.addLayer(basemap7, vis, '2017-06', false);
Map.addLayer(basemap8, vis, '2017-12', false);
Map.addLayer(basemap9,  vis, '2018-06', false);
Map.addLayer(basemap10,  vis, '2018-12', false);
Map.addLayer(basemap11,  vis, '2019-06', false);
Map.addLayer(basemap12,  vis, '2019-12', false);
Map.addLayer(basemap13,  vis, '2020-06', false);
Map.addLayer(basemap14,  vis, '2020-12', false);
Map.addLayer(basemap15,  vis, '2021-06', false);
*/


var Mine = function(param) {
  
  var _this = this;
  
  var assets = {
    mosaics: ee.ImageCollection('projects/mapbiomas-raisg/MOSAICOS/mosaics-pathrow-2').filterMetadata('region_code', 'equals', 304),
    roi: ee.FeatureCollection('users/mapbiomas_andessur/Mineria/' + param.roi),
    palette: require('users/mapbiomas/modules:Palettes.js').get('classification6'),
    regions: ee.FeatureCollection('users/mapbiomas_andessur/Mineria/RegionesClassif_Mineria_Colombia_08032023')
  };
  

  
  /**
   * Init application
   */
  var init = function(param) {

    // parameters
    var country = param.country;
    var regionIds = param.regions;
    var mosaicRegionsIds = [304];
    var newAreas = param.newAreas;
    var trees = param.trees;
    var years = param.years;
    var variables = param.variables;
    var samplesVersion = param.samplesVersion;
    var outputVersion = param.outputVersion;
    var additionalSamples = param.additionalSamples;
    var exclusionAreas = param.exclusion;
    var outputPath = 'projects/mapbiomas-raisg/TRANSVERSALES/' +  country + '/COLECCION5/MINERIA/clasificacion/';
    var samplesPath = 'projects/mapbiomas-raisg/MUESTRAS/' + 'VENEZUELA' + '/COLECCION4/TRANSVERSALES/MINERIA/PUNTOS/';

    var region = assets.regions.filter(ee.Filter.inList('id_regionC', regionIds));
    var mosaics = assets.mosaics.filter(ee.Filter.bounds(region));

    var allExclusionAreas, exclusionStartingMask, exclusionFinishMask;
    if(exclusionAreas && exclusionAreas.length > 0 ) {
      allExclusionAreas = ee.FeatureCollection(exclusionAreas);
        //.map(function(item) { return item.set('version', 1) });
      
      exclusionStartingMask = allExclusionAreas
        .reduceToImage(['start'], ee.Reducer.first())
        .clipToBoundsAndScale({
          geometry: allExclusionAreas.geometry(),
          scale: 30
        });
        
      exclusionFinishMask = allExclusionAreas
        .reduceToImage(['finish'], ee.Reducer.first())
        .clipToBoundsAndScale({
          geometry: allExclusionAreas.geometry(),
          scale: 30
        });
    }



    // compute yearly classifications and save them to a multiband image
    var classified, miningArea, newMiningAreas;

    if(newAreas && newAreas.length > 0) {
      newMiningAreas = ee.FeatureCollection(newAreas);
      miningArea = assets.roi.merge(newMiningAreas);
    } else miningArea = assets.roi;
    


    
    years.forEach(function(year, i) {
      
      // samples
      var yearMosaic = mosaics
        .filterMetadata('year', 'equals', year)
        .median();
        
      var yearMiningArea = newMiningAreas//.filterMetadata('year', 'equals', year);
      var miningArea = newAreas ? assets.roi.merge(yearMiningArea) : assets.roi;

      
      // load samples
      var samplesAssetName = 'VENEZUELA' + '-' + [902, 905].join('-') + '-' + year + '-' + samplesVersion;
      var samples = _this.loadSamples(yearMosaic.clip(region), variables, samplesPath, samplesAssetName);
      
      
      if(additionalSamples.polygons.length > 0) {
        var newSamples = _this.resampleCover(yearMosaic, additionalSamples, year);
        samples = newSamples ? samples.merge(newSamples) : samples;
      }
      
      var bandName = 'classification_' + year;
      var classification = _this.applyClassifier(yearMosaic, variables, trees, samples, bandName, miningArea)
        .where(exclusionStartingMask.lte(year).and(exclusionFinishMask.gte(year)), 27);
      
      // run classification
      classified = i === 0 ? classification : classified.addBands(classification);
      
      
      /**
       * Visualizations
       */
      // mosaic
      Map.addLayer(
        yearMosaic,
        { min: 200, max: 5000, bands: 'swir1_median,nir_median,red_median' },
        'MOSAICO ' + year,
        false
      );
      
      // samples
      var styledPoints = samples.map(
        function(point) {
          var value = point.get('reference');
          value = ee.Algorithms.If(ee.Algorithms.IsEqual(value, 27), 0, 1);
  
          var classId = ee.Number(value).byte();
          
          var color = ee.List(['BBBBBB', 'darkred']).get(classId);
          
          return point.set({ style: { color: color } });
        }
      );
      
      Map.addLayer(
        styledPoints.style({ styleProperty: "style", width: 0.5}),
        {},
        'MUESTRAS ' + year,
        false
      );
      
      // classification
      Map.addLayer(
        classification.updateMask(classification.eq(30)),
        {palette: 'darkred'},
        'CLASIFICACIÓN ' + year,
        false
      );
      
      
      
    });
    Map.addLayer(miningArea.style({'color':'cyan','fillColor':'00000000'}),{},'ROI');
    Map.addLayer(region.style({'color':'000000','fillColor':'00000000'}),{},'Regiones')
    /**
     * Export data
     */
    var outputName = country + '-' + regionIds.join('-') +
    //'-' + years.join('-') + 
    '-' + outputVersion;
    
    classified = classified.set({
      regions: regionIds,
      country: country,
      version: outputVersion,
      trees: trees,
      samples_version: samplesVersion,
      description: 'preliminar classification',
    });
    
    Export.image.toAsset({
      image: classified,
      description: outputName,
      assetId: outputPath + outputName,
      scale: 30,
      maxPixels: 1e13,
      region: region.geometry().bounds(),
      pyramidingPolicy: {'.default': 'mode'}
    });
    
  };
  
  
  
  /**
   * Load samples 
   */
  this.loadSamples = function(mosaic, variables, path, assetname) {

    mosaic = variables.length > 0 ? mosaic.select(variables) : mosaic;
    var bands = mosaic.bandNames();
    var contained = bands.containsAll(ee.List(variables));
    
    return ee.FeatureCollection(
      ee.Algorithms.If(
        contained,
        ee.FeatureCollection(path + assetname),
        null
      )
    )
    .select(bands.add('reference'))
    .filter(ee.Filter.notNull(bands));
  };
  
  
  
  /**
   * Identify number of classes in the samples.
   */
  this.checkClassesInSamples = function(mosaic, variables, samples) {
    
    mosaic = variables.length > 0 ? mosaic.select(variables) : mosaic;
    var bands = mosaic.bandNames();
    var contained = bands.containsAll(ee.List(variables));

    var nClasSample = ee.List(
      ee.Algorithms.If(
        contained,
        samples
          .reduceColumns(ee.Reducer.toList(), ['reference'])
          .get('list'),
        null
      )
    );
    
    return nClasSample.reduce(ee.Reducer.countDistinct());
  };
  
  
  /**
   * Additional samples
   */
  this.resampleCover = function(mosaic, additionalSamples, year) {
    
    var polygons = additionalSamples.polygons,
        classIds = additionalSamples.classes,
        points = additionalSamples.points,
        
        newSamples = [];
    
      
    polygons.forEach(function(polygon, i) {
      
      var start = polygon.get('start').getInfo();
      var finish = polygon.get('finish').getInfo();
      
      if(year <= finish && year >= start) {

        var newSample = mosaic.sample({
          numPixels: points[ i ],
          region: polygon.geometry(),
          scale: 30,
          projection: 'EPSG:4326',
          seed: 1,
          tileScale: 8,
          geometries: true
        })
        .map(function(item) { return item.set('reference', classIds[ i ]) });
        
        newSamples.push(newSample);
      }
  
    });
    
    return ee.FeatureCollection(newSamples).flatten();

  
  };

  
  
  
  /**
   * 
   */
  this.applyClassifier = function(mosaic, variables, trees, samples, outputband, region) {

    mosaic = variables.length > 0 ? mosaic.select(variables) : mosaic;
    var bands = mosaic.bandNames();
    var contained = bands.containsAll(ee.List(variables));
    var nClasses = _this.checkClassesInSamples(mosaic, variables, samples);
    
    var classifier = ee.Classifier.smileRandomForest({
      numberOfTrees: trees, 
      variablesPerSplit: 1
    });
    
    classifier = ee.Classifier(
      ee.Algorithms.If(
        contained,
        ee.Algorithms.If(
          // solución al problema 'only one class'
          ee.Algorithms.IsEqual(nClasses, 1),
          null,
          classifier.train(samples, 'reference', bands)
        ),
        null
      )
    );
    
    var image = mosaic.classify(classifier);
    image = outputband ? image.select(['classification'], [outputband]) : image;
    var maskBand = outputband ? ee.Image(27).rename(outputband) : ee.Image(27);
    
    return ee.Image(
      ee.Algorithms.If(
        contained,
        ee.Algorithms.If(
          // Solution to problem 'only one class'
          ee.Algorithms.IsEqual(nClasses, 1), maskBand, image
        ),
        maskBand
      )
    )
    .unmask(27)
    .clip(region).toByte();

  };
  
  
  // Init application
  return init(param);
  
};



new Mine(param);
